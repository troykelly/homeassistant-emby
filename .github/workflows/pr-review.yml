name: PR Code Review

on:
  # Trigger when CI checks complete
  workflow_run:
    workflows: ["CI", "HACS Validation", "Validate with hassfest"]
    types:
      - completed
    branches:
      - main

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Only run if triggered by a PR and all checks passed
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:pr is:open head:${context.payload.workflow_run.head_branch}`,
            });
            const pr = response.data.items[0];
            if (pr) {
              core.setOutput('number', pr.number);
              core.setOutput('found', 'true');
            } else {
              core.setOutput('found', 'false');
            }

      - name: Wait for all checks to pass
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const checkNames = ['CI', 'HACS Validation', 'Validate with hassfest'];
            const headSha = context.payload.workflow_run.head_sha;

            // Wait up to 5 minutes for all checks
            for (let i = 0; i < 30; i++) {
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: headSha,
              });

              const relevantChecks = checkRuns.check_runs.filter(
                cr => checkNames.some(name => cr.name.includes(name) || name.includes(cr.name))
              );

              const allCompleted = relevantChecks.length >= 3 &&
                relevantChecks.every(cr => cr.status === 'completed');
              const allSuccess = relevantChecks.every(
                cr => cr.conclusion === 'success' || cr.conclusion === 'skipped'
              );

              if (allCompleted && allSuccess) {
                console.log('All CI checks passed!');
                return;
              }

              if (allCompleted && !allSuccess) {
                const failed = relevantChecks.filter(cr => cr.conclusion !== 'success' && cr.conclusion !== 'skipped');
                core.setFailed(`CI checks failed: ${failed.map(cr => cr.name).join(', ')}`);
                return;
              }

              console.log(`Waiting for checks... (${relevantChecks.filter(cr => cr.status === 'completed').length}/${checkNames.length} completed)`);
              await new Promise(r => setTimeout(r, 10000));
            }

            core.setFailed('Timeout waiting for CI checks');

      - name: Checkout
        if: steps.pr.outputs.found == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Review with Claude
        if: steps.pr.outputs.found == 'true'
        uses: grll/claude-code-action@beta
        with:
          use_oauth: true
          claude_access_token: ${{ secrets.CLAUDE_ACCESS_TOKEN }}
          claude_refresh_token: ${{ secrets.CLAUDE_REFRESH_TOKEN }}
          claude_expires_at: ${{ secrets.CLAUDE_EXPIRES_AT }}
          secrets_admin_pat: ${{ secrets.SECRETS_ADMIN_PAT }}
          timeout_minutes: 10
          direct_prompt: |
            You are reviewing a Pull Request for the Home Assistant Emby Media integration.

            ## PR Details
            - **Repository:** ${{ github.repository }}
            - **PR Number:** ${{ steps.pr.outputs.number }}
            - **Head Branch:** ${{ github.event.workflow_run.head_branch }}
            - **Head SHA:** ${{ github.event.workflow_run.head_sha }}

            First, get the full PR details:
            ```
            gh pr view ${{ steps.pr.outputs.number }} --json title,author,body,files
            ```

            ## Your Task

            Perform a thorough code review focusing on:

            ### 1. Code Quality
            - Clean, readable code
            - Appropriate naming conventions
            - No unnecessary complexity
            - DRY principle (Don't Repeat Yourself)

            ### 2. Type Safety (CRITICAL for this project)
            - **NO `Any` type usage** (except `**kwargs: Any` for HA base class overrides)
            - All functions must have return type annotations
            - Use `TypedDict` for API response structures
            - Use modern syntax: `str | None` not `Optional[str]`
            - Use `from __future__ import annotations`

            ### 3. Testing
            - All new code should have corresponding tests
            - Tests should follow TDD pattern (test written first)
            - Check for adequate test coverage
            - Tests should be meaningful, not just for coverage

            ### 4. Home Assistant Patterns
            - Proper use of `_attr_*` pattern for entity attributes
            - No I/O in properties
            - Correct use of `async`/`await`
            - Proper coordinator usage
            - Config flow best practices

            ### 5. Security
            - No hardcoded credentials or secrets
            - Proper input validation
            - Safe handling of user data
            - No command injection vulnerabilities

            ### 6. Documentation
            - Docstrings for public functions/classes
            - Comments for complex logic
            - Updated README/docs if needed

            ### 7. Breaking Changes
            - Identify any breaking changes
            - Check for backward compatibility
            - Note any migration requirements

            ## Review Guidelines

            - Be constructive and helpful
            - Explain WHY something should be changed, not just WHAT
            - Provide code examples for suggested improvements
            - Acknowledge good practices you see
            - Prioritize issues (blocking vs. suggestions)

            ## Output Format

            Use `gh pr review` to submit your review:

            **If changes are needed:**
            ```
            gh pr review ${{ steps.pr.outputs.number }} --request-changes --body "review comments"
            ```

            **If approved:**
            ```
            gh pr review ${{ steps.pr.outputs.number }} --approve --body "approval message"
            ```

            **If just commenting:**
            ```
            gh pr review ${{ steps.pr.outputs.number }} --comment --body "comments"
            ```

            For specific line comments, use:
            ```
            gh api repos/${{ github.repository }}/pulls/${{ steps.pr.outputs.number }}/comments \
              -f body="comment" -f commit_id="${{ github.event.workflow_run.head_sha }}" -f path="file.py" -F line=123
            ```

            ## Important Notes

            - First, examine the diff to understand all changes: `gh pr diff ${{ steps.pr.outputs.number }}`
            - Check which files were modified: `gh pr view ${{ steps.pr.outputs.number }} --json files`
            - For this project, type safety and testing are non-negotiable
            - Be especially careful with changes to config_flow.py, coordinator.py, and API handling

          allowed_tools: "Bash(gh pr:*),Bash(gh api:*),Bash(git diff:*),Bash(git log:*),Bash(git show:*)"
